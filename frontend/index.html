<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCash Transactions Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background-color: #f5f5f5;
    }
    .flex {
      display: flex;
    }
    .sidebar {
      width: 200px;
      background-color: #1a2526;
      color: white;
      height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
    }
    .sidebar h1 {
      background-color: #0055A4;
      padding: 10px;
      font-size: 18px;
      margin: 0 0 20px 0;
      text-align: center;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 0 0 20px 0;
    }
    .sidebar li {
      margin-bottom: 15px;
    }
    .sidebar a {
      color: white;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    .sidebar a:hover {
      text-decoration: underline;
    }
    .sidebar a.active {
      font-weight: bold;
      color: #007bff;
    }
    .latest-transaction, .notes-section {
      background-color: #2a3b3d;
      border: 1px solid #4a5b5d;
      border-radius: 5px;
      padding: 10px;
      color: white;
      margin-bottom: 20px;
    }
    .latest-transaction h2, .notes-section h2 {
      font-size: 14px;
      margin-bottom: 10px;
      margin-top: 0;
    }
    .latest-transaction table {
      width: 100%;
      border-collapse: collapse;
    }
    .latest-transaction th, .latest-transaction td {
      padding: 3px;
      font-size: 10px;
      text-align: left;
      word-wrap: break-word;
    }
    .latest-transaction th {
      font-weight: normal;
      color: #ccc;
    }
    .notes-section textarea {
      width: 100%;
      padding: 5px;
      border: 1px solid #4a5b5d;
      border-radius: 3px;
      background-color: #3a4b4d;
      color: white;
      font-size: 12px;
      resize: none;
      box-sizing: border-box;
    }
    .notes-section button {
      padding: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 12px;
      cursor: pointer;
      width: 100%;
      margin-top: 5px;
    }
    .notes-section button:hover {
      background-color: #0056b3;
    }
    .notes-section ul {
      list-style: none;
      padding: 0;
      margin: 10px 0 0 0;
      max-height: 150px;
      overflow-y: auto;
    }
    .notes-section li {
      background-color: #3a4b4d;
      padding: 5px;
      border-radius: 3px;
      margin-bottom: 5px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .notes-section li button {
      padding: 3px 8px;
      font-size: 10px;
      width: auto;
      margin-left: 5px;
    }
    .notes-section li .complete-btn {
      background-color: #28a745;
    }
    .notes-section li .complete-btn:hover {
      background-color: #218838;
    }
    .notes-section li .delete-btn {
      background-color: #dc3545;
    }
    .notes-section li .delete-btn:hover {
      background-color: #c82333;
    }
    .notes-section .note-timestamp {
      color: #ccc;
      font-size: 10px;
      margin-bottom: 3px;
    }
    .notes-section .note-content {
      flex: 1;
    }
    .main-content {
      flex: 1;
      padding: 20px;
    }
    .content-section {
      display: none;
    }
    .content-section.active {
      display: block;
    }
    .summary-cards {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .summary-card {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      flex: 1;
      text-align: center;
    }
    .summary-card h2 {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    .summary-card p {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin: 5px 0;
    }
    .summary-card .stats-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .summary-card .stat-item {
      font-size: 16px;
      font-weight: normal;
      color: #333;
    }
    .summary-card .balance-input {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .summary-card input[type="number"] {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    .summary-card button {
      padding: 5px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
    }
    .summary-card button:hover {
      background-color: #0056b3;
    }
    .form-and-fee {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .transaction-form {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      flex: 2;
    }
    .transaction-form h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .form-grid label {
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }
    .form-grid input, .form-grid select {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .form-grid button {
      padding: 8px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
      grid-column: span 2;
    }
    .form-grid button:hover {
      background-color: #0056b3;
    }
    .fee-table {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      flex: 1;
      max-height: 300px;
      overflow: auto;
    }
    .fee-table h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .fee-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .fee-table th, .fee-table td {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    .fee-table th {
      background-color: #f8f9fa;
      font-weight: normal;
      color: #666;
    }
    .fetch-search {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .fetch-search h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .fetch-search .flex {
      gap: 10px;
      align-items: flex-end;
    }
    .fetch-search label {
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }
    .fetch-search input, .fetch-search select {
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
    }
    .fetch-search button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
    }
    .fetch-search .fetch-btn {
      background-color: #007bff;
      color: white;
    }
    .fetch-search .fetch-btn:hover {
      background-color: #0056b3;
    }
    .fetch-search .download-btn {
      background-color: #28a745;
      color: white;
    }
    .fetch-search .download-btn:hover {
      background-color: #218838;
    }
    .fetch-search .search-btn {
      background-color: #007bff;
      color: white;
    }
    .fetch-search .search-btn:hover {
      background-color: #0056b3;
    }
    .fetch-search .clear-btn {
      background-color: #6c757d;
      color: white;
    }
    .fetch-search .clear-btn:hover {
      background-color: #5a6268;
    }
    .transaction-table {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
    }
    .transaction-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .transaction-table th, .transaction-table td {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    .transaction-table th {
      background-color: #f8f9fa;
      font-weight: normal;
      color: #666;
    }
    .transaction-table .edit-btn {
      background-color: #28a745;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
      margin-right: 5px;
    }
    .transaction-table .delete-btn {
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
    }
    .transaction-table .total-fee {
      text-align: right;
      font-weight: bold;
      padding: 10px;
      font-size: 14px;
    }
    .reports-section {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .reports-section h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .reports-section table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    .reports-section th, .reports-section td {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    .reports-section th {
      background-color: #f8f9fa;
      font-weight: normal;
      color: #666;
    }
    .user-search {
      margin-bottom: 15px;
    }
    .user-search label {
      display: block;
      font-size: 14px;
      color: #333;
      margin-bottom: 5px;
    }
    .user-search input {
      width: 100%;
      max-width: 300px;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }
    .pagination button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
      background-color: #007bff;
      color: white;
    }
    .pagination button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .pagination button:hover:not(:disabled) {
      background-color: #0056b3;
    }
    .pagination span {
      font-size: 14px;
    }
    .fee-comparison {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .fee-comparison-text {
      flex: 1;
    }
    .fee-comparison-text p {
      font-size: 14px;
      margin: 5px 0;
    }
    .fee-comparison-chart {
      flex: 1;
      max-width: 300px;
      height: 200px;
    }
    .settings-section {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .settings-section h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .backup-restore .flex {
      gap: 10px;
      align-items: center;
    }
    .backup-restore button {
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
    }
    .backup-restore .backup-btn {
      background-color: #007bff;
      color: white;
    }
    .backup-restore .backup-btn:hover {
      background-color: #0056b3;
    }
    .backup-restore .restore-btn {
      background-color: #28a745;
      color: white;
    }
    .backup-restore .restore-btn:hover {
      background-color: #218838;
    }
    .remarks-sent { background-color: #ADD8E6; }
    .remarks-claimed { background-color: #90EE90; }
    .remarks-load { background-color: #FFDAB9; }
    .remarks-cuana { background-color: #FFFF00; }
    .remarks-unpaid { background-color: #FFCCCB; }
    .chart-container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-between;
    }
    .chart-container .trend-chart {
      flex: 2;
      min-width: 300px;
    }
    .chart-container .type-breakdown-chart {
      flex: 1;
      min-width: 250px;
      max-width: 300px;
      margin: 0 auto;
    }
    .trend-controls button.prev-btn,
    .trend-controls button.next-btn {
      padding: 5px 10px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      font-size: 14px;
      cursor: pointer;
    }
    .trend-controls button.prev-btn:hover,
    .trend-controls button.next-btn:hover {
      background-color: #0056b3;
    }
    #trendChart {
      min-height: 200px;
    }
    .unclaimed-unpaid-table {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
    }
    .unclaimed-unpaid-table h2 {
      font-size: 16px;
      margin-bottom: 15px;
    }
    .unclaimed-unpaid-table table {
      width: 100%;
      border-collapse: collapse;
    }
    .unclaimed-unpaid-table th,
    .unclaimed-unpaid-table td {
      padding: 10px;
      text-align: center;
      font-size: 14px;
      border-bottom: 1px solid #eee;
    }
    .unclaimed-unpaid-table th {
      background-color: #f8f9fa;
      font-weight: normal;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="flex">
    <div class="sidebar">
      <h1>GCash Inventory</h1>
      <ul>
        <li><a onclick="showSection('dashboard')" class="active">Dashboard</a></li>
        <li><a onclick="showSection('transactions')">Transactions</a></li>
        <li><a onclick="showSection('reports')">Reports</a></li>
        <li><a onclick="showSection('settings')">Settings</a></li>
      </ul>
      <div class="latest-transaction">
        <h2>Latest Transaction</h2>
        <table>
          <tr>
            <th>Date</th>
            <td id="latestDate">-</td>
          </tr>
          <tr>
            <th>Time</th>
            <td id="latestTime">-</td>
          </tr>
          <tr>
            <th>Type</th>
            <td id="latestType">-</td>
          </tr>
          <tr>
            <th>Amount</th>
            <td id="latestAmount">-</td>
          </tr>
          <tr>
            <th>Name</th>
            <td id="latestName">-</td>
          </tr>
          <tr>
            <th>Ref</th>
            <td id="latestRef">-</td>
          </tr>
          <tr>
            <th>Fee</th>
            <td id="latestFee">-</td>
          </tr>
          <tr>
            <th>Remarks</th>
            <td id="latestRemarks">-</td>
          </tr>
        </table>
      </div>
      <div class="notes-section">
        <h2>Notes</h2>
        <textarea id="noteInput" rows="3" placeholder="Enter a note..."></textarea>
        <button onclick="addNote()">Add Note</button>
        <ul id="notesList"></ul>
      </div>
    </div>

    <div class="main-content">
      <div id="dashboard-section" class="content-section active">
        <div class="summary-cards">
          <div class="summary-card">
            <h2>Transaction Totals</h2>
            <div class="stats-container">
              <div class="stat-item">Cash In: <span id="totalCashIn">0.00 PHP</span></div>
              <div class="stat-item">Cash Out: <span id="totalCashOut">0.00 PHP</span></div>
              <div class="stat-item">Load: <span id="totalLoad">0.00 PHP</span></div>
            </div>
          </div>
    <div class="summary-card">
            <h2>Summary</h2>
            <div class="stats-container">
              <div class="stat-item">Total Transactions: <span id="totalTransactions">0</span></div>
              <div class="stat-item">Total Fees: <span id="totalFees">0.00 PHP</span></div>
              <div class="stat-item">Unclaimed Transactions: <span id="unclaimedCount">0</span></div>
              <div class="stat-item">Unpaid Transactions: <span id="unpaidCount">0</span></div>
            </div>
          </div>  
          <div class="summary-card">
            <h2>Current Balance</h2>
            <p id="currentBalance">0.00 PHP</p>
            <div class="balance-input">
              <input id="balanceInput" type="number" step="0.01" placeholder="Set balance">
              <button onclick="setBalance()">Set</button>
            </div>
          </div>
        </div>

        <div class="form-and-fee">
          <div class="transaction-form">
            <h2>Add Transaction</h2>
            <form id="transactionForm" onsubmit="event.preventDefault(); saveTransaction();">
              <input type="hidden" id="transactionId">
              <div class="form-grid">
                <div>
                  <label>Date:</label>
                  <input type="date" id="date" required>
                </div>
                <div>
                  <label>Time:</label>
                  <input type="time" id="time" required>
                </div>
                <div>
                  <label>Type:</label>
                  <select id="type" required>
                    <option value="Cash In">Cash In</option>
                    <option value="Cash Out">Cash Out</option>
                    <option value="Load">Load</option>
                  </select>
                </div>
                <div>
                  <label>Amount:</label>
                  <input type="number" id="amount" step="0.01" required>
                </div>
                <div>
                  <label>Name:</label>
                  <input type="text" id="name" required>
                </div>
                <div>
                  <label>Reference:</label>
                  <input type="text" id="ref" required>
                </div>
                <div>
                  <label>Fee:</label>
                  <input type="number" id="fee" step="0.01" required>
                </div>
                <div>
                  <label>Remarks:</label>
                  <input type="text" id="remarks" required>
                </div>
                <button type="submit" id="submitButton">Add Transaction</button>
              </div>
            </form>
          </div>

          <div class="fee-table">
            <h2>Fee Table</h2>
            <table>
              <thead>
                <tr>
                  <th>Amount Range (PHP)</th>
                  <th>Fee (PHP)</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>1 - 100</td><td>5</td></tr>
                <tr><td>101 - 500</td><td>10</td></tr>
                <tr><td>501 - 1000</td><td>15</td></tr>
                <tr><td>1001 - 1500</td><td>20</td></tr>
                <tr><td>1501 - 2000</td><td>30</td></tr>
                <tr><td>2001 - 2500</td><td>35</td></tr>
                <tr><td>2501 - 3000</td><td>45</td></tr>
                <tr><td>3001 - 3500</td><td>50</td></tr>
                <tr><td>3501 - 4000</td><td>60</td></tr>
                <tr><td>4001 - 4500</td><td>65</td></tr>
                <tr><td>4501 - 5000</td><td>75</td></tr>
                <tr><td>5001 - 5500</td><td>80</td></tr>
                <tr><td>5501 - 6000</td><td>90</td></tr>
                <tr><td>6001 - 6500</td><td>95</td></tr>
                <tr><td>6501 - 7000</td><td>105</td></tr>
                <tr><td>7001 - 7500</td><td>110</td></tr>
                <tr><td>7501 - 8000</td><td>120</td></tr>
                <tr><td>8001 - 8500</td><td>125</td></tr>
                <tr><td>8501 - 9000</td><td>135</td></tr>
                <tr><td>9001 - 9500</td><td>140</td></tr>
                <tr><td>9501 - 10000</td><td>150</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="chart-container">
          <div class="reports-section trend-chart">
            <h2>Transaction Trends</h2>
            <div class="trend-controls" style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 15px;">
              <div>
                <label>Start Date:</label>
                <input type="date" id="trendStartDate" onchange="fetchTransactionTrends()">
              </div>
              <div>
                <label>End Date:</label>
                <input type="date" id="trendEndDate" onchange="fetchTransactionTrends()">
              </div>
              <button onclick="shiftTrendRange('prev')" class="prev-btn">Previous</button>
              <button onclick="shiftTrendRange('next')" class="next-btn">Next</button>
            </div>
            <canvas id="trendChart"></canvas>
          </div>
          <div class="reports-section type-breakdown-chart">
            <h2>Transaction Type Breakdown</h2>
            <canvas id="typeBreakdownChart"></canvas>
          </div>
        </div>
        <div class="summary-card">
  <h2>Unclaimed/Unpaid Transactions</h2>
  <div id="unclaimedUnpaidList">
    <p id="noUnclaimedUnpaid" class="text-center">No unclaimed or unpaid transactions</p>
  </div>
</div>
      </div>

      <div id="transactions-section" class="content-section">
        <div class="fetch-search">
          <h2>Fetch Transactions for Date:</h2>
          <div class="flex">
            <div>
              <label>Fetch Transactions for Date:</label>
              <input type="date" id="fetchDate">
            </div>
            <div>
              <label>Sort By (Optional):</label>
              <select id="sortBy">
                <option value="id">None</option>
                <option value="id">ID</option>
                <option value="time">Time</option>
                <option value="type">Type</option>
                <option value="amount">Amount</option>
                <option value="name">Name</option>
                <option value="ref">Reference</option>
                <option value="fee">Fee</option>
                <option value="remarks">Remarks</option>
              </select>
            </div>
            <button onclick="fetchTransactions()" class="fetch-btn">Fetch</button>
            <button onclick="downloadSummary()" class="download-btn">Download PDF Summary</button>
            <div>
              <label>Search in:</label>
              <select id="searchField">
                <option value="id">ID</option>
                <option value="date">Date</option>
                <option value="time">Time</option>
                <option value="type">Type</option>
                <option value="amount">Amount</option>
                <option value="name">Name</option>
                <option value="ref">Reference</option>
                <option value="fee">Fee</option>
                <option value="remarks">Remarks</option>
              </select>
            </div>
            <div>
              <label>Keyword:</label>
              <input type="text" id="searchKeyword" placeholder="Enter keyword">
            </div>
            <button onclick="fetchTransactions()" class="search-btn">Search</button>
            <button onclick="clearSearch()" class="clear-btn">Clear Search</button>
          </div>
        </div>

        <div class="transaction-table">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Date</th>
                <th>Time</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Name</th>
                <th>Reference</th>
                <th>Fee</th>
                <th>Remarks</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="transactionTable"></tbody>
          </table>
          <div class="total-fee" id="totalFeeDisplay">Total Fee: 0.00 PHP</div>
        </div>
      </div>

      <div id="reports-section" class="content-section">
        <div class="reports-section">
          <h2>User Transactions Report</h2>
          <div class="user-search">
            <label>Search by Name:</label>
            <input type="text" id="userSearch" placeholder="Enter name to filter">
          </div>
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Cash In</th>
                <th>Cash Out</th>
                <th>Load</th>
                <th>Total Fee (PHP)</th>
                <th>Last Transaction</th>
              </tr>
            </thead>
            <tbody id="userTransactionsTable"></tbody>
          </table>
          <div class="pagination">
            <button id="userPrevPage" onclick="prevUserPage()">Previous</button>
            <span id="userPageNumber">Page 1</span>
            <button id="userNextPage" onclick="nextUserPage()">Next</button>
          </div>
        </div>
        <div class="reports-section">
          <h2>Monthly Transaction Reports</h2>
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Total Transactions</th>
                <th>Total Amount (PHP)</th>
                <th>Total Fee (PHP)</th>
              </tr>
            </thead>
            <tbody id="monthlyTransactionsTable"></tbody>
          </table>
          <div class="fee-comparison">
            <div class="fee-comparison-text">
              <h2>Fee Comparison: This Month vs Last Month</h2>
              <p id="thisMonthFee">This Month: 0.00 PHP</p>
              <p id="lastMonthFee">Last Month: 0.00 PHP</p>
              <p id="feeDifference">Difference: 0.00 PHP</p>
            </div>
            <div class="fee-comparison-chart">
              <canvas id="feeComparisonChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div id="settings-section" class="content-section">
        <div class="settings-section">
          <h2>Backup & Restore</h2>
          <div class="backup-restore">
            <div class="flex">
              <button onclick="backupDatabase()" class="backup-btn">Backup Database</button>
              <input type="file" id="restoreFile" accept=".sql">
              <button onclick="restoreDatabase()" class="restore-btn">Restore Database</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// Global variables
  let currentUserPage = 1;
  const usersPerPage = 10;
  let trendChart = null;
  let typeBreakdownChart = null;
  let feeChart = null;

  // Utility functions
  function getManilaDate() {
    const now = new Date();
    const manilaTime = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Manila',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).format(now);
    return manilaTime; // Returns YYYY-MM-DD format
  }

  function setTodayDate() {
    const today = getManilaDate();
    document.getElementById('date').value = today;
    document.getElementById('fetchDate').value = today;
  }

  function initializeTrendDates() {
    const today = new Date();
    const endDate = getManilaDate();
    const startDate = new Date(today);
    startDate.setDate(today.getDate() - 6); // Default to 7 days including today
    const startDateStr = startDate.toISOString().split('T')[0];
    document.getElementById('trendStartDate').value = startDateStr;
    document.getElementById('trendEndDate').value = endDate;
  }

  // Navigation
  function showSection(section) {
    document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
    document.getElementById(`${section}-section`).classList.add('active');
    document.querySelectorAll('.sidebar a').forEach(a => a.classList.remove('active'));
    document.querySelector(`.sidebar a[onclick="showSection('${section}')"]`).classList.add('active');

    if (section === 'dashboard') {
      fetchBalance();
      fetchTransactions();
      fetchTransactionTrends();
      fetchTypeBreakdown();
      fetchNotes();
      fetchUnclaimedUnpaidTransactions(); // Initial load
    } else if (section === 'transactions') {
      fetchTransactions();
    } else if (section === 'reports') {
      fetchUserTransactions();
      fetchMonthlyTransactions();
      fetchFeeComparison();
    }
  }

  // Notes Management
  async function addNote() {
    const noteInput = document.getElementById('noteInput');
    const noteText = noteInput.value.trim();
    if (!noteText) {
      alert('Please enter a note.');
      return;
    }

    try {
      const response = await fetch('http://localhost:5000/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: noteText }),
      });
      const data = await response.json();
      if (data.id) {
        noteInput.value = '';
        fetchNotes();
      } else {
        throw new Error('Failed to save note');
      }
    } catch (error) {
      console.error('Error saving note:', error);
      alert('Failed to save note');
    }
  }

  async function completeNote(id) {
    try {
      const response = await fetch(`http://localhost:5000/api/notes/${id}/complete`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
      });
      const data = await response.json();
      if (data.message) {
        fetchNotes(); // Refresh list to hide completed note
      } else {
        throw new Error('Failed to mark note as completed');
      }
    } catch (error) {
      console.error('Error marking note as completed:', error);
      alert('Failed to mark note as completed');
    }
  }

  async function deleteNote(id) {
    if (!confirm('Are you sure you want to delete this note?')) return;

    try {
      const response = await fetch(`http://localhost:5000/api/notes/${id}`, {
        method: 'DELETE',
      });
      const data = await response.json();
      if (data.message) {
        fetchNotes();
      } else {
        throw new Error('Failed to delete note');
      }
    } catch (error) {
      console.error('Error deleting note:', error);
      alert('Failed to delete note');
    }
  }

  async function fetchNotes() {
    try {
      const response = await fetch('http://localhost:5000/api/notes');
      const notes = await response.json();
      displayNotes(notes);
    } catch (error) {
      console.error('Error fetching notes:', error);
    }
  }

  function displayNotes(notes) {
    const notesList = document.getElementById('notesList');
    notesList.innerHTML = '';
    notes.forEach(note => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="note-content">
          <div class="note-timestamp">${new Date(note.created_at).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</div>
          <div>${note.content}</div>
        </div>
        <button class="complete-btn" onclick="completeNote(${note.id})">✔</button>
        <button class="delete-btn" onclick="deleteNote(${note.id})">Delete</button>
      `;
      notesList.appendChild(li);
    });
  }

  // Balance Management
  async function fetchBalance() {
    try {
      const response = await fetch('http://localhost:5000/api/balance');
      const data = await response.json();
      if (data.balance !== undefined) {
        document.getElementById('currentBalance').textContent = `${parseFloat(data.balance).toFixed(2)} PHP`;
      }
    } catch (error) {
      console.error('Error fetching balance:', error);
    }
  }

  async function setBalance() {
    const balanceInput = document.getElementById('balanceInput').value;
    const balance = parseFloat(balanceInput);
    if (isNaN(balance) || balance < 0) {
      alert('Please enter a valid positive number for the balance.');
      return;
    }

    try {
      const response = await fetch('http://localhost:5000/api/balance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ balance }),
      });
      const data = await response.json();
      if (data.message) {
        alert('Balance updated successfully');
        fetchBalance();
        document.getElementById('balanceInput').value = '';
      }
    } catch (error) {
      console.error('Error setting balance:', error);
      alert('Failed to set balance');
    }
  }

  // Transaction Management
  async function saveTransaction() {
    const id = document.getElementById('transactionId').value;
    let remarks = document.getElementById('remarks').value;

    // Normalize "unclaimed" and "unpaid" to uppercase for consistency
    const remarksUpper = remarks.toUpperCase();
    if (remarksUpper.includes('UNCLAIMED')) {
      remarks = remarks.replace(/unclaimed/gi, 'UNCLAIMED');
    }
    if (remarksUpper.includes('UNPAID')) {
      remarks = remarks.replace(/unpaid/gi, 'UNPAID');
    }

    const transaction = {
      date: document.getElementById('date').value,
      time: document.getElementById('time').value,
      type: document.getElementById('type').value,
      amount: parseFloat(document.getElementById('amount').value),
      name: document.getElementById('name').value,
      ref: document.getElementById('ref').value,
      fee: parseFloat(document.getElementById('fee').value),
      remarks: remarks
    };

    const url = id ? `http://localhost:5000/api/transactions/${id}` : 'http://localhost:5000/api/transactions';
    const method = id ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(transaction),
      });
      const data = await response.json();
      if (data.message) {
        alert(id ? 'Transaction updated successfully' : 'Transaction saved successfully');
        document.getElementById('transactionForm').reset();
        document.getElementById('transactionId').value = '';
        document.getElementById('submitButton').textContent = 'Add Transaction';
        document.getElementById('date').value = getManilaDate();
        document.getElementById('time').focus();
        fetchTransactions();
        fetchBalance();
        fetchLatestTransaction();
        fetchTransactionTrends();
        fetchTypeBreakdown();
        fetchUnclaimedUnpaidTransactions(); // Refresh unclaimed/unpaid list
      }
    } catch (error) {
      console.error('Error saving transaction:', error);
      alert('Failed to save transaction');
    }
  }

  async function fetchLatestTransaction() {
    try {
      const response = await fetch('http://localhost:5000/api/transactions?sortBy=id&order=desc&limit=1');
      const data = await response.json();
      const latest = data.transactions && data.transactions.length > 0 ? data.transactions[0] : null;

      if (latest) {
        document.getElementById('latestDate').textContent = latest.date || '-';
        document.getElementById('latestTime').textContent = latest.time ? latest.time.split(':').slice(0, 2).join(':') : '-';
        document.getElementById('latestType').textContent = latest.type || '-';
        document.getElementById('latestAmount').textContent = latest.amount ? parseFloat(latest.amount).toFixed(2) : '-';
        document.getElementById('latestName').textContent = latest.name || '-';
        document.getElementById('latestRef').textContent = latest.ref || '-';
        document.getElementById('latestFee').textContent = latest.fee ? parseFloat(latest.fee).toFixed(2) : '-';
        document.getElementById('latestRemarks').textContent = latest.remarks || '-';
        console.log('Latest transaction data:', latest); // Debug log
      } else {
        document.getElementById('latestDate').textContent = '-';
        document.getElementById('latestTime').textContent = '-';
        document.getElementById('latestType').textContent = '-';
        document.getElementById('latestAmount').textContent = '-';
        document.getElementById('latestName').textContent = '-';
        document.getElementById('latestRef').textContent = '-';
        document.getElementById('latestFee').textContent = '-';
        document.getElementById('latestRemarks').textContent = '-';
        console.log('No latest transaction found');
      }
    } catch (error) {
      console.error('Error fetching latest transaction:', error);
      alert('Failed to fetch latest transaction');
    }
  }

  async function fetchTransactions() {
    const date = document.getElementById('fetchDate').value || getManilaDate();
    const searchField = document.getElementById('searchField').value;
    const searchKeyword = document.getElementById('searchKeyword').value;
    const sortBy = document.getElementById('sortBy').value;
    const url = new URL('http://localhost:5000/api/transactions');
    if (date) url.searchParams.append('date', date);
    if (searchField && searchKeyword) {
      url.searchParams.append('searchField', searchField);
      url.searchParams.append('search', searchKeyword);
    }
    if (sortBy && sortBy !== 'id') {
      url.searchParams.append('sortBy', sortBy);
    }

    try {
      const response = await fetch(url);
      const data = await response.json();
      const transactions = data.transactions || [];
      const totalFee = data.totalFee || 0;
      const totalCashIn = data.totalCashIn || 0;
      const totalCashOut = data.totalCashOut || 0;
      const totalLoad = data.totalLoad || 0;
      const totalTransactions = data.totalTransactions || 0;
      const unclaimedCount = data.unclaimedCount || 0;
      const unpaidCount = data.unpaidCount || 0;

      document.getElementById('totalFeeDisplay').textContent = `Total Fee: ${parseFloat(totalFee).toFixed(2)} PHP`;
      document.getElementById('totalCashIn').textContent = `${parseFloat(totalCashIn).toFixed(2)} PHP`;
      document.getElementById('totalCashOut').textContent = `${parseFloat(totalCashOut).toFixed(2)} PHP`;
      document.getElementById('totalLoad').textContent = `${parseFloat(totalLoad).toFixed(2)} PHP`;
      document.getElementById('totalFees').textContent = `${parseFloat(totalFee).toFixed(2)} PHP`;
      document.getElementById('totalTransactions').textContent = totalTransactions;
      document.getElementById('unclaimedCount').textContent = unclaimedCount;
      document.getElementById('unpaidCount').textContent = unpaidCount;

      const tableBody = document.getElementById('transactionTable');
      tableBody.innerHTML = '';
      transactions.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${t.id}</td>
          <td>${t.date}</td>
          <td>${t.time.split(':').slice(0, 2).join(':')}</td>
          <td>${t.type}</td>
          <td>${parseFloat(t.amount).toFixed(2)}</td>
          <td>${t.name}</td>
          <td>${t.ref}</td>
          <td>${parseFloat(t.fee).toFixed(2)}</td>
          <td class="remarks-${t.remarks.toLowerCase()}">${t.remarks}</td>
          <td>
            <button class="edit-btn" onclick="editTransaction(${t.id})">Edit</button>
            <button class="delete-btn" onclick="deleteTransaction(${t.id})">Delete</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error('Error fetching transactions:', error);
      alert('Failed to fetch transactions');
    }
  }

  async function fetchUnclaimedUnpaidTransactions() {
    try {
      const response = await fetch('http://localhost:5000/api/transactions/unclaimed-unpaid');
      const data = await response.json();
      const list = document.getElementById('unclaimedUnpaidList');
      list.innerHTML = '';

      if (data.transactions && data.transactions.length > 0) {
        data.transactions.forEach(transaction => {
          const div = document.createElement('div');
          div.className = 'stat-item';
          div.innerHTML = `
            <p>Date: ${transaction.date} | Time: ${transaction.time.split(':').slice(0, 2).join(':')} | Type: ${transaction.type} | Amount: ${parseFloat(transaction.amount).toFixed(2)} | Name: ${transaction.name} | Ref: ${transaction.ref} | Fee: ${parseFloat(transaction.fee).toFixed(2)} | Remarks: ${transaction.remarks}</p>
            <button class="edit-btn" onclick="editTransaction(${transaction.id})">Edit</button>
          `;
          list.appendChild(div);
        });
        document.getElementById('noUnclaimedUnpaid').style.display = 'none';
      } else {
        document.getElementById('noUnclaimedUnpaid').style.display = 'block';
      }
    } catch (error) {
      console.error('Error fetching unclaimed/unpaid transactions:', error);
      document.getElementById('unclaimedUnpaidList').innerHTML = '<p class="text-center">Error loading transactions</p>';
    }
  }

  async function editTransaction(id) {
    try {
      const response = await fetch(`http://localhost:5000/api/transactions?searchField=id&search=${id}`);
      const data = await response.json();
      const transaction = data.transactions[0];
      if (transaction) {
        document.getElementById('transactionId').value = transaction.id;
        document.getElementById('date').value = transaction.date;
        document.getElementById('time').value = transaction.time;
        document.getElementById('type').value = transaction.type;
        document.getElementById('amount').value = transaction.amount;
        document.getElementById('name').value = transaction.name;
        document.getElementById('ref').value = transaction.ref;
        document.getElementById('fee').value = transaction.fee;
        document.getElementById('remarks').value = transaction.remarks;
        document.getElementById('submitButton').textContent = 'Update Transaction';
        showSection('dashboard');
      }
    } catch (error) {
      console.error('Error fetching transaction for edit:', error);
      alert('Failed to load transaction');
    }
  }

  async function deleteTransaction(id) {
    if (!confirm('Are you sure you want to delete this transaction?')) return;

    try {
      const response = await fetch(`http://localhost:5000/api/transactions/${id}`, {
        method: 'DELETE',
      });
      const data = await response.json();
      if (data.message) {
        alert('Transaction deleted successfully');
        fetchTransactions();
        fetchBalance();
        fetchLatestTransaction();
        fetchTransactionTrends();
        fetchTypeBreakdown();
        fetchUnclaimedUnpaidTransactions(); // Refresh unclaimed/unpaid list
      }
    } catch (error) {
      console.error('Error deleting transaction:', error);
      alert('Failed to delete transaction');
    }
  }

  async function downloadSummary() {
    const date = document.getElementById('fetchDate').value || getManilaDate();
    const sortBy = document.getElementById('sortBy').value;
    const url = new URL('http://localhost:5000/api/transactions/download');
    if (date) url.searchParams.append('date', date);
    if (sortBy && sortBy !== 'id') url.searchParams.append('sortBy', sortBy);

    try {
      const response = await fetch(url);
      const blob = await response.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `transactions_${date || 'all'}.pdf`;
      link.click();
      URL.revokeObjectURL(link.href);
    } catch (error) {
      console.error('Error downloading summary:', error);
      alert('Failed to download summary');
    }
  }

  function clearSearch() {
    document.getElementById('searchField').value = 'id';
    document.getElementById('searchKeyword').value = '';
    fetchTransactions();
  }

  // Reports Management
  async function fetchUserTransactions() {
    const search = document.getElementById('userSearch').value;
    const url = new URL('http://localhost:5000/api/reports/user-transactions');
    url.searchParams.append('page', currentUserPage);
    url.searchParams.append('limit', usersPerPage);
    if (search) url.searchParams.append('search', search);

    try {
      const response = await fetch(url);
      const data = await response.json();
      const userTransactions = data.userTransactions || [];
      const totalUsers = data.totalUsers || 0;

      const tableBody = document.getElementById('userTransactionsTable');
      tableBody.innerHTML = '';
      userTransactions.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${t.name}</td>
          <td>${parseFloat(t.cashIn).toFixed(2)}</td>
          <td>${parseFloat(t.cashOut).toFixed(2)}</td>
          <td>${parseFloat(t.load).toFixed(2)}</td>
          <td>${parseFloat(t.totalFee).toFixed(2)}</td>
          <td>${new Date(t.lastTransaction).toLocaleString('en-US', { timeZone: 'Asia/Manila' })}</td>
        `;
        tableBody.appendChild(row);
      });

      document.getElementById('userPageNumber').textContent = `Page ${currentUserPage}`;
      document.getElementById('userPrevPage').disabled = currentUserPage === 1;
      document.getElementById('userNextPage').disabled = currentUserPage * usersPerPage >= totalUsers;
    } catch (error) {
      console.error('Error fetching user transactions:', error);
      alert('Failed to fetch user transactions');
    }
  }

  function prevUserPage() {
    if (currentUserPage > 1) {
      currentUserPage--;
      fetchUserTransactions();
    }
  }

  function nextUserPage() {
    currentUserPage++;
    fetchUserTransactions();
  }

  async function fetchMonthlyTransactions() {
    try {
      const response = await fetch('http://localhost:5000/api/reports/monthly-transactions');
      const data = await response.json();
      const monthlyTransactions = data.monthlyTransactions || [];

      const tableBody = document.getElementById('monthlyTransactionsTable');
      tableBody.innerHTML = '';
      monthlyTransactions.forEach(t => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${t.month}</td>
          <td>${t.totalTransactions}</td>
          <td>${parseFloat(t.totalAmount).toFixed(2)}</td>
          <td>${parseFloat(t.totalFee).toFixed(2)}</td>
        `;
        tableBody.appendChild(row);
      });
    } catch (error) {
      console.error('Error fetching monthly transactions:', error);
      alert('Failed to fetch monthly transactions');
    }
  }

  async function fetchFeeComparison() {
    try {
      const response = await fetch('http://localhost:5000/api/reports/fee-comparison');
      const data = await response.json();

      document.getElementById('thisMonthFee').textContent = `This Month (${data.thisMonthName}): ${parseFloat(data.thisMonthFee).toFixed(2)} PHP`;
      document.getElementById('lastMonthFee').textContent = `Last Month (${data.lastMonthName}): ${parseFloat(data.lastMonthFee).toFixed(2)} PHP`;
      const difference = data.thisMonthFee - data.lastMonthFee;
      document.getElementById('feeDifference').textContent = `Difference: ${difference.toFixed(2)} PHP`;

      if (feeChart) feeChart.destroy();
      feeChart = new Chart(document.getElementById('feeComparisonChart'), {
        type: 'bar',
        data: {
          labels: [data.lastMonthName, data.thisMonthName],
          datasets: [{
            label: 'Fees (PHP)',
            data: [data.lastMonthFee, data.thisMonthFee],
            backgroundColor: ['#007bff', '#28a745'],
          }],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Fees (PHP)' } },
            x: { title: { display: true, text: 'Month' } },
          },
        },
      });
    } catch (error) {
      console.error('Error fetching fee comparison:', error);
      alert('Failed to fetch fee comparison');
    }
  }

  async function fetchTransactionTrends() {
    const startDate = document.getElementById('trendStartDate').value;
    const endDate = document.getElementById('trendEndDate').value;
    if (!startDate || !endDate) return;

    try {
      const response = await fetch(`http://localhost:5000/api/reports/trend?startDate=${startDate}&endDate=${endDate}`);
      const data = await response.json();

      const labels = data.map(d => d.date);
      const amounts = data.map(d => parseFloat(d.total_amount));

      if (trendChart) trendChart.destroy();
      trendChart = new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Total Amount (PHP)',
            data: amounts,
            borderColor: '#007bff',
            fill: false,
          }],
        },
        options: {
          plugins: { legend: { display: true } },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Amount (PHP)' } },
            x: { title: { display: true, text: 'Date' } },
          },
        },
      });
    } catch (error) {
      console.error('Error fetching transaction trends:', error);
      alert('Failed to fetch transaction trends');
    }
  }

  function shiftTrendRange(direction) {
    let startDate = new Date(document.getElementById('trendStartDate').value);
    let endDate = new Date(document.getElementById('trendEndDate').value);
    const diffDays = Math.round((endDate - startDate) / (1000 * 60 * 60 * 24));

    if (direction === 'prev') {
      startDate.setDate(startDate.getDate() - diffDays);
      endDate.setDate(endDate.getDate() - diffDays);
    } else {
      startDate.setDate(startDate.getDate() + diffDays);
      endDate.setDate(endDate.getDate() + diffDays);
    }

    document.getElementById('trendStartDate').value = startDate.toISOString().split('T')[0];
    document.getElementById('trendEndDate').value = endDate.toISOString().split('T')[0];
    fetchTransactionTrends();
  }

  async function fetchTypeBreakdown() {
    try {
      const response = await fetch('http://localhost:5000/api/reports/type-breakdown');
      const data = await response.json();

      const labels = ['Cash In', 'Cash Out', 'Load'];
      const counts = [
        data['Cash In'] || 0,
        data['Cash Out'] || 0,
        data['Load'] || 0,
      ];

      if (typeBreakdownChart) typeBreakdownChart.destroy();
      typeBreakdownChart = new Chart(document.getElementById('typeBreakdownChart'), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: counts,
            backgroundColor: ['#007bff', '#dc3545', '#ffc107'],
          }],
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
        },
      });
    } catch (error) {
      console.error('Error fetching type breakdown:', error);
      alert('Failed to fetch type breakdown');
    }
  }

  // Backup and Restore
  async function backupDatabase() {
    try {
      const response = await fetch('http://localhost:5000/api/backup');
      const blob = await response.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `gcash_backup_${new Date().toISOString().replace(/[:.]/g, '-')}.sql`;
      link.click();
      URL.revokeObjectURL(link.href);
      alert('Backup created successfully');
    } catch (error) {
      console.error('Error creating backup:', error);
      alert('Failed to create backup');
    }
  }

  async function restoreDatabase() {
    const fileInput = document.getElementById('restoreFile');
    const file = fileInput.files[0];
    if (!file) {
      alert('Please select a backup file to restore.');
      return;
    }

    const formData = new FormData();
    formData.append('backupFile', file);

    try {
      const response = await fetch('http://localhost:5000/api/restore', {
        method: 'POST',
        body: formData,
      });
      const data = await response.json();
      if (data.message) {
        alert('Database restored successfully');
        fileInput.value = '';
        fetchBalance();
        fetchTransactions();
        fetchLatestTransaction();
        fetchNotes();
        fetchTransactionTrends();
        fetchTypeBreakdown();
      }
    } catch (error) {
      console.error('Error restoring database:', error);
      alert('Failed to restore database');
    }
  }

  // Event Listeners
  document.getElementById('userSearch').addEventListener('input', () => {
    currentUserPage = 1;
    fetchUserTransactions();
  });

  // Initialization
  setTodayDate();
  initializeTrendDates();
  showSection('dashboard');
</script>
</body>
</html>